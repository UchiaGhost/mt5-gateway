<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_name }} - n8n Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
</head>
<body class="bg-gray-50" x-data="n8nIntegration()">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900">{{ app_name }}</h1>
                    </div>
                    <div class="hidden md:ml-6 md:flex md:space-x-8">
                        <a href="/" class="text-gray-500 hover:text-gray-700 px-1 pt-1 text-sm font-medium">Dashboard</a>
                        <a href="/config" class="text-gray-500 hover:text-gray-700 px-1 pt-1 text-sm font-medium">Konfiguration</a>
                        <a href="/n8n" class="text-blue-600 border-b-2 border-blue-600 px-1 pt-1 text-sm font-medium">n8n Integration</a>
                        <a href="/logs" class="text-gray-500 hover:text-gray-700 px-1 pt-1 text-sm font-medium">Logs</a>
                        <a href="/license" class="text-gray-500 hover:text-gray-700 px-1 pt-1 text-sm font-medium">Lizenz</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Quick Start -->
        <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-8">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-400"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">n8n Integration - Erste Schritte</h3>
                    <div class="mt-2 text-sm text-blue-700">
                        <p>Verwenden Sie den HTTP Request Node in n8n, um Trading-Signale an das MT5 Gateway zu senden.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Endpoint -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">API Endpoint</h3>
                <div class="bg-gray-100 rounded-md p-4">
                    <code class="text-sm font-mono">POST {{ request.url_root }}api/v1/signal</code>
                </div>
            </div>
        </div>

        <!-- Beispiel Request -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Beispiel Request</h3>
                <div class="space-y-4">
                    <!-- Headers -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Headers</h4>
                        <pre class="bg-gray-100 rounded-md p-4 text-sm overflow-x-auto"><code class="language-json">{
  "Content-Type": "application/json",
  "X-API-KEY": "pub_xxxxx",
  "X-TS": "1695555555",
  "X-NONCE": "9f2a1c0c7b1e4d8e",
  "X-SIGNATURE": "&lt;calculated_hmac&gt;"
}</code></pre>
                    </div>
                    
                    <!-- Body -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Body</h4>
                        <pre class="bg-gray-100 rounded-md p-4 text-sm overflow-x-auto"><code class="language-json">{
  "strategy": "breakout-v1",
  "symbol": "EURUSD",
  "side": "buy",
  "type": "market",
  "risk": {
    "percent": 1.0
  },
  "sl": {
    "pips": 20
  },
  "tp": {
    "pips": 40
  },
  "comment": "n8n-signal-123",
  "idempotency_key": "b0f7b..."
}</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- n8n Node Konfiguration -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">n8n HTTP Request Node Konfiguration</h3>
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Method</label>
                            <div class="bg-gray-100 rounded-md p-3">
                                <code class="text-sm">POST</code>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">URL</label>
                            <div class="bg-gray-100 rounded-md p-3">
                                <code class="text-sm">{{ request.url_root }}api/v1/signal</code>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Headers</label>
                        <div class="bg-gray-100 rounded-md p-3">
                            <pre class="text-sm"><code>Content-Type: application/json
X-API-KEY: {{ api_config.public_key }}
X-TS: {{ timestamp }}
X-NONCE: {{ nonce }}
X-SIGNATURE: {{ signature }}</code></pre>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Body</label>
                        <div class="bg-gray-100 rounded-md p-3">
                            <pre class="text-sm"><code>{{ request_body }}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- cURL Beispiel -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">cURL Beispiel</h3>
                <div class="bg-gray-900 rounded-md p-4">
                    <pre class="text-green-400 text-sm overflow-x-auto"><code>curl -X POST "{{ request.url_root }}api/v1/signal" \
  -H "Content-Type: application/json" \
  -H "X-API-KEY: pub_xxxxx" \
  -H "X-TS: 1695555555" \
  -H "X-NONCE: 9f2a1c0c7b1e4d8e" \
  -H "X-SIGNATURE: &lt;calculated_hmac&gt;" \
  -d '{
    "strategy":"breakout-v1",
    "symbol":"EURUSD",
    "side":"buy",
    "type":"market",
    "risk":{"percent":1.0},
    "sl":{"pips":20},
    "tp":{"pips":40},
    "idempotency_key":"abc-123"
  }'</code></pre>
                </div>
                <button @click="copyCurlExample()" class="mt-4 bg-blue-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-copy mr-2"></i>cURL kopieren
                </button>
            </div>
        </div>

        <!-- Test Signal -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Test Signal senden</h3>
                <form @submit.prevent="sendTestSignal()">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="test_strategy" class="block text-sm font-medium text-gray-700">Strategie</label>
                            <input type="text" id="test_strategy" x-model="testSignal.strategy" value="test-strategy" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="test_symbol" class="block text-sm font-medium text-gray-700">Symbol</label>
                            <select id="test_symbol" x-model="testSignal.symbol" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="EURUSD">EURUSD</option>
                                <option value="GBPUSD">GBPUSD</option>
                                <option value="USDJPY">USDJPY</option>
                                <option value="AUDUSD">AUDUSD</option>
                            </select>
                        </div>
                        <div>
                            <label for="test_side" class="block text-sm font-medium text-gray-700">Seite</label>
                            <select id="test_side" x-model="testSignal.side" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>
                        </div>
                        <div>
                            <label for="test_risk" class="block text-sm font-medium text-gray-700">Risiko (%)</label>
                            <input type="number" step="0.1" min="0.1" max="5" id="test_risk" x-model="testSignal.risk.percent" value="0.5" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="submit" :disabled="sending" class="bg-green-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50">
                            <i class="fas fa-paper-plane mr-2"></i>
                            <span x-text="sending ? 'Sende...' : 'Test Signal senden'"></span>
                        </button>
                    </div>
                </form>
                
                <!-- Test Result -->
                <div x-show="testResult" class="mt-6 p-4 rounded-md" :class="testResult.success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas" :class="testResult.success ? 'fa-check-circle text-green-400' : 'fa-exclamation-circle text-red-400'"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium" :class="testResult.success ? 'text-green-800' : 'text-red-800'">
                                <span x-text="testResult.success ? 'Signal erfolgreich gesendet' : 'Fehler beim Senden des Signals'"></span>
                            </h3>
                            <div class="mt-2 text-sm" :class="testResult.success ? 'text-green-700' : 'text-red-700'">
                                <pre x-text="JSON.stringify(testResult, null, 2)"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Troubleshooting -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Troubleshooting</h3>
                <div class="space-y-4">
                    <div class="border-l-4 border-yellow-400 bg-yellow-50 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                            </div>
                            <div class="ml-3">
                                <h4 class="text-sm font-medium text-yellow-800">401 Unauthorized</h4>
                                <p class="mt-1 text-sm text-yellow-700">Überprüfen Sie Ihre API-Keys und die HMAC-Signatur</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-l-4 border-red-400 bg-red-50 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-times-circle text-red-400"></i>
                            </div>
                            <div class="ml-3">
                                <h4 class="text-sm font-medium text-red-800">422 Unprocessable Entity</h4>
                                <p class="mt-1 text-sm text-red-700">Überprüfen Sie die Request-Parameter und Trading-Limits</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-l-4 border-blue-400 bg-blue-50 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-blue-400"></i>
                            </div>
                            <div class="ml-3">
                                <h4 class="text-sm font-medium text-blue-800">503 Service Unavailable</h4>
                                <p class="mt-1 text-sm text-blue-700">MT5-Verbindung nicht verfügbar. Überprüfen Sie die MT5-Konfiguration</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function n8nIntegration() {
            return {
                testSignal: {
                    strategy: 'test-strategy',
                    symbol: 'EURUSD',
                    side: 'buy',
                    risk: { percent: 0.5 }
                },
                testResult: null,
                sending: false,
                
                async sendTestSignal() {
                    this.sending = true;
                    this.testResult = null;
                    
                    try {
                        const response = await fetch('/api/v1/signal', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-API-KEY': 'test_key' // Für Test-Zwecke
                            },
                            body: JSON.stringify(this.testSignal)
                        });
                        
                        const result = await response.json();
                        this.testResult = {
                            success: response.ok,
                            status: response.status,
                            data: result
                        };
                        
                    } catch (error) {
                        this.testResult = {
                            success: false,
                            error: error.message
                        };
                    } finally {
                        this.sending = false;
                    }
                },
                
                copyCurlExample() {
                    const curlText = `curl -X POST "{{ request.url_root }}api/v1/signal" \\
  -H "Content-Type: application/json" \\
  -H "X-API-KEY: pub_xxxxx" \\
  -H "X-TS: 1695555555" \\
  -H "X-NONCE: 9f2a1c0c7b1e4d8e" \\
  -H "X-SIGNATURE: <calculated_hmac>" \\
  -d '{
    "strategy":"breakout-v1",
    "symbol":"EURUSD",
    "side":"buy",
    "type":"market",
    "risk":{"percent":1.0},
    "sl":{"pips":20},
    "tp":{"pips":40},
    "idempotency_key":"abc-123"
  }'`;
                    
                    navigator.clipboard.writeText(curlText).then(() => {
                        alert('cURL-Befehl in die Zwischenablage kopiert');
                    });
                }
            }
        }
    </script>
</body>
</html>
